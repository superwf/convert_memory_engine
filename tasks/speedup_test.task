require 'rails'
require File.join(Rails.root, 'config/environment')
desc 'convert mysql tables engine to memory in test database'
task :speedup_test do
  db = ::ActiveRecord::Base.connection
  if ::Rails.env.test?
    tables = db.tables
    tables.delete 'schema_migrations'
    tables.each do |t|
      begin
        model_class = eval(t.classify)
        model_class.columns.each do |c|
          if c.type == :text
            db.execute "ALTER TABLE #{t} CHANGE #{c.name} #{c.name} VARCHAR(255)"
          end
          if c.name == "creator_id"
            db.execute "ALTER TABLE #{t} CHANGE #{c.name} #{c.name} INT(11) UNSIGNED NULL"
          end
        end
      rescue
        puts "no model for table #{t}"
      end
      db.execute "ALTER TABLE #{t} ENGINE= MEMORY"
    end
    exit
  else
    raise "only in test mode"
  end
end
